<% if current_user.profile_image.attached? %>
  <%= cl_image_tag(current_user.profile_image.key, width: 100) %>
<% end %>

<h2 class="section-title">My Programmes</h2>
<div class="programmes-container">
  <% @programmes.each do |programme| %>
    <%= link_to programme do  %>
      <div class='programme-card block border card'>
        <h4 class="programme-name"><%= programme.name %></h4>
        <p><%= programme.splits_per_week %> workouts per week for <%= programme.weeks %> weeks</p>
        <p class="categories"><%= programme.splits.map(&:category).join(' - ') %></p>
        <% total_workouts = programme.splits_per_week * programme.weeks %>
        <% completion_rate = ((programme.workouts.count.to_f / total_workouts)*100).round(2) %>
        <% if completion_rate > 100 %>
          <% completion_rate = 100 %>
        <% end %>
        <% unless completion_rate.zero? %>
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: <%= completion_rate %>%;" aria-valuenow="<%= completion_rate %>" aria-valuemin="0" aria-valuemax="100">
              <%= completion_rate %>% Completed
            </div>
          </div>
          <% end %>
        </div>
    <% end %>
  <% end %>
</div>
<h2 class="section-title">My Workouts</h2>
<%= month_calendar(events: @workouts, attribute: :date) do |workout| %>
  <div class="workout">
    <p>Category: <%= workout.split.category</p> %>
    <p>Date: <%= workout.date</p> %>
  </div>
<% end %>



<h2 class="section-title">My Progress</h2>
<div id="carouselIndicators" class="carousel slide" data-bs-ride="carousel">
  <!-- Carousel Inner -->
  <div class="carousel-inner">
     <!-- Set 1st one as active class -->
     <div class="carousel-item active">
        <div class="exercise-card d-block border card">
          <% logs = @exercises.first.logs.sort_by { |log| log.workout.date }.reverse %>
          <% log_history = {} %>
          <% logs.each do |log| %>
            <% one_rep_max = log.weight * (1 + (log.repetitions / 30.0)) %>
            <% date = log.workout.date.strftime('%Y-%m-%d') %>
            <% if log_history[date].nil? || log_history[date] < one_rep_max %>
              <% log_history[date] = one_rep_max.round(1) %>
            <% end %>
          <% end %>
          <%= line_chart log_history, xtitle: "Date", ytitle: "1 Rep Max(kg)", label: "1RM", title: @exercises.first.name %>
        </div>
      </div>

    <% @exercises.each_with_index do |exercise, index| %>
      <div class="carousel-item">
        <div class="exercise-card d-block border card">
          <ul class="exercise-logs">
            <% logs = exercise.logs.sort_by { |log| log.workout.date }.reverse %>
            <% log_history = {} %>
            <% logs.each do |log| %>
              <% one_rep_max = log.weight * (1 + (log.repetitions / 30.0)) %>
              <% date = log.workout.date.strftime('%Y-%m-%d') %>
              <% if log_history[date].nil? || log_history[date] < one_rep_max %>
                <% log_history[date] = one_rep_max.round(1) %>
              <% end %>
            <% end %>
          </ul>
          <!-- Display Chart -->
          <%= line_chart log_history, xtitle: "Date", ytitle: "1 Rep Max(kg)", label: "1RM", title: exercise.name %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Carousel Controls -->
  <button class="carousel-control-prev" data-bs-target="#carouselIndicators" role="button" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </button>
  <button class="carousel-control-next" data-bs-target="#carouselIndicators" role="button" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </button>
</div>



<%= link_to 'Log out', destroy_user_session_path, method: :delete, data: { turbo_method: :delete, confirm: 'Are you sure you want to log out?' }, class: 'logout-btn' %>
</div>
